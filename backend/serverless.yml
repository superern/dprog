service: dprog-backend

frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs18.x
  region: ${env:AWS_REGION, "us-east-1"}
  environment:
    S3_BUCKET: ${env:S3_BUCKET, "dprog"}
    S3_ENDPOINT: ${env:S3_ENDPOINT, ""}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    OPENAI_EMBED_MODEL: ${env:OPENAI_EMBED_MODEL, "text-embedding-3-small"}
    OPENAI_CHAT_MODEL: ${env:OPENAI_CHAT_MODEL, "gpt-4o-mini"}
    PINECONE_API_KEY: ${env:PINECONE_API_KEY}
    PINECONE_INDEX: ${env:PINECONE_INDEX}
    PINECONE_HOST: ${env:PINECONE_HOST, ""}
    PINECONE_NAMESPACE: ${env:PINECONE_NAMESPACE, ""}
    SQS_ENDPOINT: ${env:SQS_ENDPOINT, "http://localhost:9324"}
    SQS_QUEUE_URL: ${env:SQS_QUEUE_URL, "http://localhost:9324/000000000000/ingest-q"}

plugins:
  - serverless-esbuild
  - serverless-offline-sqs
  - serverless-offline
  - serverless-dotenv-plugin
  - serverless-s3-local

useDotenv: true

custom:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    target: "node18"
    platform: "node"
    format: "cjs"
  serverless-offline:
    httpPort: 8080
  s3:
    host: localhost
    port: 4569
    directory: .s3
  serverless-offline-sqs:
    autoCreate: false
    apiVersion: "2012-11-05"
    endpoint: http://localhost:9324
    region: ${env:AWS_REGION, "us-east-1"}
    accessKeyId: root
    secretAccessKey: root
  dotenv:
    path: .env

functions:
  ingest:
    handler: src/handlers/ingest/ingest.handler
    events:
      - sqs: arn:aws:sqs:${self:provider.region}:000000000000:ingest-q
  ingestRequest:
    handler: src/handlers/ingest/request.handler
    events:
      - httpApi:
          path: /ingest
          method: post
  presign:
    handler: src/handlers/ingest/presign.handler
    events:
      - httpApi:
          path: /presign
          method: post
  ask:
    handler: src/handlers/ask.handler
    events:
      - httpApi:
          path: /ask
          method: post
  enqueue:
    handler: src/handlers/enqueue.handler
    events:
      - httpApi:
          path: /enqueue
          method: post
  ingestQueueWorker:
    handler: src/handlers/sqs.handler
    events:
      - sqs:
          arn: arn:aws:sqs:${self:provider.region}:000000000000:ingest-q

resources:
  Resources:
    DprogBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: dprog
    IngestDlq:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ingest-dlq
    IngestQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ingest-q
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt:
              - IngestDlq
              - Arn
          maxReceiveCount: 3
