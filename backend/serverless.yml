service: dprog-backend

frameworkVersion: "3"

provider:
  name: aws
  runtime: nodejs18.x
  region: ${env:AWS_REGION, "us-east-1"}
  environment:
    S3_BUCKET: ${env:S3_BUCKET, "dprog"}
    S3_ENDPOINT: ${env:S3_ENDPOINT, ""}
    OPENAI_API_KEY: ${env:OPENAI_API_KEY}
    OPENAI_EMBED_MODEL: ${env:OPENAI_EMBED_MODEL, "text-embedding-3-small"}
    OPENAI_CHAT_MODEL: ${env:OPENAI_CHAT_MODEL, "gpt-4o-mini"}
    PINECONE_API_KEY: ${env:PINECONE_API_KEY}
    PINECONE_INDEX: ${env:PINECONE_INDEX}
    PINECONE_HOST: ${env:PINECONE_HOST, ""}
    PINECONE_NAMESPACE: ${env:PINECONE_NAMESPACE, ""}
    SQS_ENDPOINT: ${env:SQS_ENDPOINT, "http://localhost:4566"}
    SQS_QUEUE_URL: ${env:SQS_QUEUE_URL, "http://localhost:4566/000000000000/ingest-q"}
    TIKA_URL: ${env:TIKA_URL, "http://localhost:9998"}
    S3_RAW_PREFIX: ${env:S3_RAW_PREFIX, "raw/"}
    S3_DONE_PREFIX: ${env:S3_DONE_PREFIX, "done/"}

plugins:
  - serverless-esbuild
  - serverless-offline-sqs
  - serverless-offline
  - serverless-localstack
  - serverless-dotenv-plugin

useDotenv: true

custom:
  esbuild:
    bundle: true
    minify: false
    sourcemap: true
    target: "node18"
    platform: "node"
    format: "cjs"
    outputWorkFolder: "esbuild"
    outputBuildFolder: "build"
    keepOutputDirectory: true
  serverless-offline:
    httpPort: 8080
  serverless-offline-sqs:
    autoCreate: true
    apiVersion: "2012-11-05"
    endpoint: http://localhost:4566
    region: ${env:AWS_REGION, "us-east-1"}
    accessKeyId: ${env:AWS_ACCESS_KEY_ID, "test"}
    secretAccessKey: ${env:AWS_SECRET_ACCESS_KEY, "test"}
  localstack:
    stages:
      - local
    host: http://localhost
    edgePort: 4566
    autostart: false
  dotenv:
    path: .env

functions:
  presign:
    handler: src/handlers/ingest/presign.handler
    events:
      - http:
          path: /ingest/presign
          method: post
          cors: true
  textract:
    handler: src/handlers/ingest/textract.handler
    events:
      - s3:
          bucket: dprog
          event: s3:ObjectCreated:*
          rules:
            - prefix: raw/
  ingest:
    handler: src/handlers/ingest/ingest.handler
    events:
      - sqs: arn:aws:sqs:${self:provider.region}:000000000000:ingest-q

#  I will retain this just in case I need again for better UI
  ingestRequest:
    handler: src/handlers/ingest/request.handler
    events:
      - http:
          path: /ingest
          method: post
          cors: true
  ask:
    handler: src/handlers/ask.handler
    events:
      - http:
          path: /ask
          method: post
          cors: true
resources:
  Resources:
    DprogBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: dprog
    IngestDlq:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ingest-dlq
    IngestQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ingest-q
